<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, intital-scale=1">
        <title>Messaging app</title>
    </head>
    <body>
        <div id="server_setup">
            <input type="text" id="server_ip_writing_box">
            <button onclick="open_websocket()">Connect to server</button>
        </div>
        <div id="user_login">
            <input type="text" id="userid_writing_box">
            <button onclick="set_userid()">Set userid</button>
        </div>
        <div id="conversation_selection">
            <input type="text" id="conversation_selection_writing_box">
            <button onclick="select_conversation()">Select conversation</button>
        </div>
        <div id="message_history"></div>
        <div id="message_writing">
            <input type="text" id="message_writing_box">
            <button onclick="send_message()">Send</button>
        </div>
        <script type="text/javascript">
            let ws = null;
            let src_userid = null;
            let dest_userid = null;

            function encrypt(message) {
                // encryption not yet implemented
                return message;
            }

            function decrypt(message) {
                // encryption not yet implemented
                return message;
            }

            function receive_message(data) {
                let message_container = document.createElement('div');

                let message_data = JSON.parse(data);
                message_container.innerText = message_data['src_userid'] + ': ' + decrypt(message_data['message']);
                document.getElementById('message_history').appendChild(message_container);
            }

            function open_websocket(trynum=0) {
                if (trynum > 5) {
                    alert('Cannot connect to websocket');
                    return;
                }
                let host = document.getElementById('server_ip_writing_box').value;
                let port = 19125;
                let address = 'ws://' + host + ':' + port;
                try {
                    ws.close();
                } catch {
                    
                }
                try {
                    ws = new WebSocket(address);
                    ws.addEventListener("message", (e) => {
                        receive_message(e.data);
                    });
                    ws.addEventListener("close", (e) => {
                        setTimeout(open_websocket, 1000, trynum++);
                    });
                } catch {
                    setTimeout(open_websocket, 1000, trynum++);
                }
            }

            function set_userid() {
                src_userid = document.getElementById('userid_writing_box').value;
            }

            function select_conversation() {
                dest_userid = document.getElementById('conversation_selection_writing_box').value;
            }

            function send_message() {
                if (!ws || !src_userid) {
                    alert('Please connect to a server, log in and select a conversation.');
                    return;
                }
                let message_json = JSON.stringify({
                    dest_userid: dest_userid,
                    src_userid: src_userid,
                    message: encrypt(document.getElementById('message_writing_box').value)
                });
                ws.send(message_json);
                receive_message(message_json); // this ensures that it appears as sent.
                document.getElementById('message_writing_box').value = "";
            }

            function check_if_enter(e, callnext) {
                if (e.code == "Enter") {
                    callnext();
                }
            }

            document.getElementById('server_ip_writing_box').onkeydown = (e) => {
                check_if_enter(e, open_websocket);
            };
            document.getElementById('userid_writing_box').onkeydown = (e) => {
                check_if_enter(e, set_userid);
            };
            document.getElementById('conversation_selection_writing_box').onkeydown = (e) => {
                check_if_enter(e, select_conversation);
            };
            document.getElementById('message_writing_box').onkeydown = (e) => {
                check_if_enter(e, send_message);
            };
        </script>
    </body>
</html>